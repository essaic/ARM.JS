<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="Assembler/ARMv4T.Assembler.js"></script>
    <script type="text/javascript" src="Assembler/ARMv4T.Assembler.Symbols.js"></script>
    <script type="text/javascript" src="Assembler/ARMv4T.Assembler.Sections.js"></script>
    <script type="text/javascript" src="Assembler/ARMv4T.Assembler.Litpools.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Vm.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Cpu.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Cpu.Instructions.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Cpu.Cpsr.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Memory.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Loader.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Loader.BinaryReader.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Device.LCDController.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Device.UART16750.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Device.PICS3C4510B.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.Device.Timer.js"></script>
    <script type="text/javascript" src="Simulator/ARM.Simulator.DevBoard.js"></script>
    <script type="text/javascript" src="Assets/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="Assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="Assets/js/codemirror.js"></script>
    <script type="text/javascript" src="Assets/js/armv4t.js"></script>
    <script type="text/javascript" src="Assets/js/gui.js"></script>
    <script type="text/javascript" src="Assets/js/devboard.js"></script>
    <script type="text/javascript" src="Assets/js/exampleELF.js"></script>
    <link rel="stylesheet" href="Assets/css/codemirror.css" />
    <link rel="stylesheet" href="Assets/css/hopscotch.css" />
    <link rel="stylesheet" href="Assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="Assets/css/gui.css" />
  </head>
  <body>
    <div id="editor"></div>
    <div id="buttons">
    <div class="btn-group">
      <button id="assemble" class="btn btn-success">Assemble Input</button>
      <button class="btn btn-success dropdown-toggle" data-toggle="dropdown">
        <span class="caret"></span>
        <span class="sr-only">Toggle Dropdown</span>
      </button>
        <ul class="dropdown-menu" id="assemble-dropdown-menu">
        </ul>
      </div>
      <div class="btn-group" data-container="body" data-trigger="focus" data-toggle="popover" data-placement="top" data-html="true" data-content="To compile programs targeting the dev board, you can use <a href='C/startup.s' target='_blank'>this</a> startup file and <a href='C/linker.ld' target='_blank'>this</a> ld linker script with the GNU ARM toolchain.<p/>The source code for Example.ELF can be found <a href='https://github.com/smiley22/ARM.JS/tree/gh-pages/C' target='_blank'>here</a>." title="Compiling C programs">
        <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Load ELF Image <span class="caret"></span></button>
        <ul class="dropdown-menu">
          <li><a href="#" id="image">Select Local File</a></li>
          <li role="separator" class="divider"></li>
          <li><a href="#" id="example-elf">Example.ELF</a></li>
        </ul>
      </div>
      <button id="run" class="btn btn-danger" disabled="disabled" data-toggle="modal" data-target="#runProgramModal">Run Program</button>
      <input type="file" id="elf-input-file" />
    </div>
    <div id="console"></div>
    <!-- RunProgram Modal -->
    <div id="runProgramModal" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Virtual Machine</h4>
          </div>
          <div class="modal-body">
            <table>
              <tbody>
                <tr>
                  <td>
                    <table id="cpu-regs">
                      <thead>
                        <tr>
                          <td class="cpu-reg">Register</td>
                          <td class="cpu-reg-val">Value</td>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td></td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                  <td>
                    <table>
                      <tr>
                        <td>
                          <table id="cpu-cpsr">
                            <thead>
                              <tr>
                                <td class="cpu-reg">CPSR</td>
                                <td class="cpu-reg-val">Value</td>
                              </tr>
                            </thead>
                            <tbody>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <table id="cpu-inst">
                            <thead>
                              <tr>
                                <td>INST</td>
                                <td>Value</td>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td class="cpu-reg" id="instr-grp"></td>
                                <td id="instr-val"></td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    </table>
                  </td>
                  <td>
                    <table>
                      <tr>
                        <td>
                          <table id="vm-mem">
                            <thead>
                              <tr>
                                <td class="cpu-reg">Memory</td>
                                <td class="cpu-reg-val">Value</td>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td colspan="2">
                                  <input type="text" id="mem-input" class="form-control" />
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <div id="devboard" data-toggle="popover" title="Development Board" data-placement="right" data-container="body" data-trigger="hover" data-delay='{"show":"0", "hide":"2500"}' data-animation="false" data-html="true" data-content="The development board features:<p/><ul><li>ARM7TDMI-like Processor</li><li>512kb flash ROM</li><li>32kb static RAM</li><li>8 LEDs</li><li>10 Push Buttons (Mapped to Keyboard keys 0-9)</li><li>2-line LCD</li><li>Interrupt Controller (PICS3C4510B)</li><li>2x UARTs (16750)</li></ul><p/>You can check out the memory map and HW register description <a href='https://github.com/smiley22/ARM.JS/blob/gh-pages/Docs/DevBoard_Datasheet.pdf' target='_blank'>here</a>.">
                            <div id="leds">
                              <div class="led" id="led-0"></div>
                              <div class="led" id="led-1"></div>
                              <div class="led" id="led-2"></div>
                              <div class="led" id="led-3"></div>
                              <div class="led" id="led-4"></div>
                              <div class="led" id="led-5"></div>
                              <div class="led" id="led-6"></div>
                              <div class="led" id="led-7"></div>
                            </div>
                            <div id="lcd">
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-0"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-1"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-2"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-3"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-4"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-5"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-6"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-7"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-8"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-9"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-10"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-11"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-12"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-13"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-14"></div>
                              <div class="lcd-cell lcd-row-0" id="lcd-cell-15"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-16"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-17"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-18"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-19"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-20"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-21"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-22"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-23"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-24"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-25"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-26"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-27"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-28"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-29"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-30"></div>
                              <div class="lcd-cell lcd-row-1" id="lcd-cell-31"></div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tbody>
              </table>
          </div>
          <div class="modal-footer">
            <button id="reset-vm" type="button" class="btn btn-default">Reset VM</button>
            <button id="single-step" type="button" class="btn btn-warning">Single-Step</button>
            <button id="execute" type="button" class="btn btn-success">Execute</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/arm-assembly" data-name="Hello World">
.arm
.section .data
hello:
    .asciz "Hello World from ARMv4T!"
.section .text
.equ   PCON,          0xE01FC000 @ Power Control Register
.equ   LCDIOCTL,      0xE000C000 @ LCD I/O Control
.equ   LCDDATA,       0xE000C004 @ LCD Data Transfer
.equ   LEDSTAT,       0xE0008000 @ LED Status Register
.equ   RAM_SIZE,      0x00008000 @ 32kb
.equ   RAM_BASE,      0x00400000
.equ   TOPSTACK,      RAM_BASE + RAM_SIZE

@ LCD initialization commands
.equ   LCD_CMD_DISP_CLEAR,    0x01
.equ   LCD_CMD_FUNCTION_SET,  0x3C
.equ   LCD_CMD_DISP_CONTROL,  0x0F
.equ   LCD_CMD_ENTRY_MODE,    0x06

@ R13 acts as stack pointer by convention
ldr  r0,  =TOPSTACK
mov  r13, r0

@ initialize LCD
bl lcd_init

loop:
  @ output string to LCD
  ldr r1, =hello
  write_char:
    ldrb r0, [r1], #1
    cmp r0, #0
    beq done
    bl lcd_write_char
    bl delay
    b write_char
done:
  @ flash LCD and LEDs
  bl flash_display
  bl flash_leds
  @ then start over again
  bl lcd_clear
  b loop

@ exit simulator
bl _exit

@ sets up the LCD display
lcd_init:
  stmfd sp!, {r0-r2,lr}
  ldr r0, =LCD_CMD_DISP_CLEAR
  bl lcd_command
  @ 2-line 5x10 dots format display mode.
  ldr r0, =LCD_CMD_FUNCTION_SET
  bl lcd_command
  @ turn display on, cursor on, blink-mode on.
  ldr r0, =LCD_CMD_DISP_CONTROL
  bl lcd_command
  @ enable cursor increment mode
  ldr r0, =LCD_CMD_ENTRY_MODE
  bl lcd_command
  ldmfd sp!, {r0-r2,lr}
  bx lr

lcd_command:
  stmfd sp!, {r1-r2,lr}
  ldr r1, =LCDIOCTL
  strb r0, [r1], #0
  mov r2, #0x80
  @ pulse enable
  strb r2, [r1], #0
  @ delay for a couple of cycles
  ldmfd sp!, {r1-r2,lr}
  bx lr

@ clears display and resets cursor
lcd_clear:
  stmfd sp!, {r0,lr}
  ldr r0, =LCD_CMD_DISP_CLEAR
  bl lcd_command
  ldmfd sp!, {r0,lr}
  bx lr

@ writes a single character to the current
@ position of the LCD cursor
lcd_write_char:
  stmfd sp!, {r1,lr}
  ldr r1, =LCDDATA
  strb r0, [r1], #0
  ldmfd sp!, {r1,lr}
  bx lr

@ writes a null-terminated string to the LCD
lcd_write_string:
  stmfd sp!, {r0-r1,lr}
  mov r1, r0
char_loop:
  ldrb r0, [r1], #1
  cmp r0, #0
  beq char_loop_end
  bl lcd_write_char
  b char_loop
char_loop_end:
  ldmfd sp!, {r0-r1,lr}
  bx lr

@ delays execution
delay:
  stmfd sp!, {r0,lr}
  ldr r0, =#200
delay_loop:
  subs r0, r0, #1
  beq delay_end
  b delay_loop
delay_end:
  ldmfd sp!, {r0,lr}
  bx lr

@ turns the display on and off a couple of times
flash_display:
  stmfd sp!, {r0-r1,lr}
  mov r1, #10
  ldr r0, =LCD_CMD_DISP_CONTROL
flash_display_loop:
    bl lcd_command
    eor r0, r0, #4
    bl delay
    subs r1, r1, #1
    bne flash_display_loop
  ldr r0, =LCD_CMD_DISP_CONTROL
  bl lcd_command
  ldmfd sp!, {r0-r1,lr}
  bx lr

@ flashes the LEDs and runs a little LED animation
flash_leds:
  stmfd sp!, {r0-r3,lr}
  mov r1, #1
  ldr r0, =LEDSTAT
flash_leds_loop:
    strb r1, [r0], #0
    movs r1, r1, LSL #1
    add r1, r1, #1
    bl delay
    cmp r1, #0xff
    ble flash_leds_loop
  mov r2, #0xff
  mov r1, #0
  mov r3, #8
toggle_all_loop:
   strb r1, [r0], #0
   eor r1, r1, r2
   bl delay
   subs r3, r3, #1
   bne toggle_all_loop
  mov r1, #0
  strb r1, [r0], #0
  ldmfd sp!, {r0-r3,lr}
  bx lr

@ halts execution
_exit:
  @ power is turned off by setting bit 1
  ldr r0, =PCON
  mov r1, #1
  strb r1, [r0]
.end
  </script>
  <script type="text/arm-assembly" data-name="Serial I/O">
.arm
.section .data
hello_sio:
    .asciz "Hello World from serial I/O!"
.section .text
@ UART0 Registers
.equ    U0RBR,            0xE0000000 @ Receiver Buffer
.equ    U0THR,            0xE0000000 @ Transmitter Holding Buffer
.equ    U0DLL,            0xE0000000 @ Divisor Latch Low Byte
.equ    U0DLH,            0xE0000004 @ Divisor Latch High Byte
.equ    U0IER,            0xE0000004 @ Interrupt Enable Register
.equ    U0IIR,            0xE0000008 @ Interrupt Identification Register
.equ    U0FCR,            0xE0000008 @ FIFO Control Register
.equ    U0LCR,            0xE000000C @ Line Control Register
.equ    U0LSR,            0xE0000014 @ Line Status Register
.equ    U0SCR,            0xE000001C @ Scratch Register

.equ    LCR8N1,           0x03       @ 8 Bits, 1 Stop bit, no parity
.equ    PCON,             0xE01FC000 @ Power Control Register

.equ    RAM_SIZE,         0x00008000 @ 32kb
.equ    RAM_BASE,         0x00400000
.equ    TOPSTACK,         RAM_BASE + RAM_SIZE

@ R13 acts as stack pointer by convention
ldr  r0,  =TOPSTACK
mov  r13, r0

@ prints a string to the 'terminal' window below
main:
  bl sio_init
  ldr r0, =hello_sio
  bl sio_puts
  @ busy wait until UART is done before exiting
  ldr r0, =U0LSR
still_busy:
    ldrb r1, [r0], #0
    ands r1, #64
    beq still_busy  
  bl _exit

@ initializes UART0
sio_init:
  stmfd sp!, {r0-r1,lr}
  ldr r0, =U0LCR
  @ enable DLAB to configure baudrate
  mov r1, #128
  strb r1, [r0], #0
  @ set baudrate to 115200 (DLH = 0x00, DLL = 0x01)
  ldr r0, =U0DLH
  mov r1, #0
  strb r1, [r0], #0
  ldr r0, =U0DLL
  mov r1, #1
  strb r1, [r0], #0
  @ clear DLAB and set mode to 8-N-1
  ldr r0, =U0LCR
  ldrb r1, =LCR8N1
  strb r1, [r0], #0
  @ disable all interrupts
  ldr r0, =U0IER
  mov r1, #0
  strb r1, [r0], #0
  @ enable and reset 64-byte FIFOs
  ldr r0, =U0FCR
  mov r1, #39
  strb r1, [r0], #0
  @ done!
  ldmfd sp!, {r0-r1,lr}
  bx lr

@ r0 -> character to transmit
sio_putc:
  stmfd sp!, {r1-r2,lr}
  ldr r1, =U0LSR
  fifo_full:
    ldrb r2, [r1], #0
    @ cleared bit 5 means TXFIFO is full
    ands r2, #32
  beq fifo_full
  ldr r1, =U0THR
  strb r0, [r1], #0
  ldmfd sp!, {r1-r2,lr}
  bx lr

@ r0 -> null-terminated string to transmit
sio_puts:
  stmfd sp!, {r0-r1,lr}
  mov r1, r0
char_loop:
  ldrb r0, [r1], #1
  cmp r0, #0
  beq char_loop_end
  bl sio_putc
  b char_loop
char_loop_end:
  ldmfd sp!, {r0-r1,lr}
  bx lr

@ halts execution
_exit:
  @ power is turned off by setting bit 1
  ldr r0, =PCON
  mov r1, #1
  strb r1, [r0]
.end
  </script>
  <script type="text/arm-assembly">
.arm
.section .text
@ TIMER0 Registers
.equ    T0_MODE,          0xE0018000 @ Mode Setting and Status Register
.equ    T0_COUNT,         0xE0018004 @ Counter Value Register
.equ    T0_COMP,          0xE0018008 @ Compare Value Register

.equ    T0_SETUP,         0x0000001c @ CPUCLK
                                     @ Zero Return Enable
                                     @ Compare Interrupt Enable

.equ    RAM_SIZE,         0x00008000 @ 32kb
.equ    RAM_BASE,         0x00400000
.equ    TOPSTACK,         RAM_BASE + RAM_SIZE

@ R13 acts as stack pointer by convention
ldr  r0,  =TOPSTACK
mov  r13, r0

main:
 bl init_timer
 loop:
   ldr r1, =T0_MODE
   ldr r2, =T0_COUNT
   ldr r3, =0x12345678
   b loop

init_timer:
  stmfd sp!, {r1-r2,lr}
  ldr r1, =T0_COMP
  ldr r2, =0x1000
  str r2, [r1], #0
  @ Enable the Timer
  ldr r1, =T0_MODE
  ldr r2, =T0_SETUP
  str r2, [r1], #0
  ldmfd sp!, {r1-r2,lr}
  bx lr

.end
  </script>
</html>