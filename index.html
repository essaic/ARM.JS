<html>
  <head>
    <script type="text/javascript" src="Assembler/ARMv4T.Assembler.js"></script>
    <script type="text/javascript" src="Assembler/ARMv4T.Assembler.Symbols.js"></script>
    <script type="text/javascript" src="Assembler/ARMv4T.Assembler.Sections.js"></script>
    <script type="text/javascript" src="Assembler/ARMv4T.Assembler.Litpools.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Vm.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Cpu.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Cpu.Instructions.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Cpu.Cpsr.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Memory.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Loader.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Loader.BinaryReader.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Device.FW.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Device.Video.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.Device.LCDController.js"></script>
		<script type="text/javascript" src="Simulator/ARM.Simulator.DevBoard.js"></script>
    <script type="text/javascript" src="Assets/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="Assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="Assets/js/codemirror.js"></script>
    <script type="text/javascript" src="Assets/js/armv4t.js"></script>
    <script type="text/javascript" src="Assets/js/gui.js"></script>
    <script type="text/javascript" src="Assets/js/devboard.js"></script>
    <script type="text/javascript" src="Assets/js/exampleELF.js"></script>
    <link rel="stylesheet" href="Assets/css/codemirror.css" />
    <link rel="stylesheet" href="Assets/css/codemirror.css" />
    <link rel="stylesheet" href="Assets/css/hopscotch.css" />
    <link rel="stylesheet" href="Assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="Assets/css/gui.css" />
  </head>
  <body>
    <div id="editor"></div>
    <div id="buttons">
      <button id="assemble" class="btn btn-success">Assemble Input</button>
      <div class="btn-group" data-container="body" data-trigger="focus" data-toggle="popover" data-placement="top" data-html="true" data-content="To compile programs targeting the dev board, you can use <a href='C/startup.s' target='_blank'>this</a> startup file and <a href='C/linker.ld' target='_blank'>this</a> ld linker script.<br/>" title="Compiling C programs">
        <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Load ELF Image <span class="caret"></span></button>
        <ul class="dropdown-menu">
          <li><a href="#" id="image">Select Local File</a></li>
          <li role="separator" class="divider"></li>
          <li><a href="#" id="example-elf">Example.ELF</a></li>
        </ul>
      </div>
      <button id="run" class="btn btn-danger" disabled="disabled" data-toggle="modal" data-target="#runProgramModal">Run Program</button>
    </div>
    <div id="console"></div>
    <!-- RunProgram Modal -->
    <div id="runProgramModal" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Virtual Machine</h4>
          </div>
          <div class="modal-body">
            <table>
              <tbody>
                <tr>
                  <td>
                    <table id="cpu-regs">
                      <thead>
                        <tr>
                          <td class="cpu-reg">Register</td>
                          <td class="cpu-reg-val">Value</td>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td></td>
                          <td></td>
                        </tr>
                      </tbody>
                    </table>
                  </td>
                  <td>
                    <table>
                      <tr>
                        <td>
                          <table id="cpu-cpsr">
                            <thead>
                              <tr>
                                <td class="cpu-reg">CPSR</td>
                                <td class="cpu-reg-val">Value</td>
                              </tr>
                            </thead>
                            <tbody>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <table id="cpu-inst">
                            <thead>
                              <tr>
                                <td>INST</td>
                                <td>Value</td>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td class="cpu-reg" id="instr-grp"></td>
                                <td id="instr-val"></td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                    </table>
                  </td>
                  <td>
                    <table>
                      <tr>
                        <td>
                          <table id="vm-mem">
                            <thead>
                              <tr>
                                <td class="cpu-reg">Memory</td>
                                <td class="cpu-reg-val">Value</td>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td class="cpu-reg"></td>
                                <td></td>
                              </tr>
                              <tr>
                                <td colspan="2">
                                  <input type="text" id="mem-input" class="form-control" />
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <div id="devboard" data-toggle="popover" title="Development Board" data-placement="left" data-animation="false" data-html="true" data-content="And here's some amazing content. It's very engaging. Right?">
                            <div id="leds">
                              <div class="led" id="led-0"></div>
                              <div class="led" id="led-1"></div>
                              <div class="led" id="led-2"></div>
                              <div class="led" id="led-3"></div>
                              <div class="led" id="led-4"></div>
                              <div class="led" id="led-5"></div>
                              <div class="led" id="led-6"></div>
                              <div class="led" id="led-7"></div>
                            </div>
                            <div id="lcd">
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-0"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-1"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-2"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-3"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-4"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-5"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-6"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-7"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-8"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-9"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-10"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-11"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-12"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-13"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-14"></div>
                              <div class="lcd-cell lcd-cell-0" id="lcd-cell-0-15"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-0"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-1"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-2"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-3"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-4"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-5"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-6"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-7"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-8"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-9"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-10"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-11"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-12"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-13"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-14"></div>
                              <div class="lcd-cell lcd-cell-1" id="lcd-cell-1-15"></div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </table>
                  </td>
                </tbody>
              </table>
          </div>
          <div class="modal-footer">
            <button id="reset-vm" type="button" class="btn btn-default">Reset VM</button>
            <button id="single-step" type="button" class="btn btn-warning">Single-Step</button>
            <button id="execute" type="button" class="btn btn-success">Execute</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script type="text/arm-assembly" id="listing-2">
.arm
.section .text
.equ   SYS_CALL,         0xFFFFFFFF
.equ   SYS_HALT,         0x01
.equ   LCDC_IOCTL,       0x8000A000
.equ   LCDC_DATA,        0x8000A001
.equ   LCD_FUNCTION_SET, 0x03
.equ   LCD_DISP_CONTROL, 0x0F
.equ   RAM_SIZE,         0x00001000
.equ   RAM_BASE,         0x00040000
.equ   TOPSTACK,         RAM_BASE + RAM_SIZE

@ R13 acts as stack pointer by convention
ldr  r0,  =TOPSTACK
mov  r13, r0

@ initialize LCD
bl lcd_init

@ exit simulator
bl _exit

lcd_init:
  stmfd sp!, {r0-r2,lr}
  @ 2-line 5x10 dots format display mode.
@  ldr r0, =LCD_FUNCTION_SET
@  bl lcd_command
  @ turn display on, cursor on, blink-mode on.
  ldr r0, =LCD_DISP_CONTROL
  bl lcd_command
  ldmfd sp!, {r0-r2,lr}
  bx lr

lcd_command:
  stmfd sp!, {r1-r2,lr}
  ldr r1, =LCDC_IOCTL
  strb r0, [r1], #0
  mov r2, #0x80
  @ pulse enable
  strb r2, [r1], #0
  @ delay for a couple of cycles
  ldmfd sp!, {r1-r2,lr}
  bx lr

@ halts execution
_exit:
  ldr r0, =SYS_CALL
  ldr r1, =SYS_HALT
  strb r1, [r0]
.end
  </script>
  <script type="text/arm-assembly" id="listing-1">
.arm
.section .data
hello:
    .asciz "Hello World from ARMv4T!\n"
.section .text
.equ    SYS_CALL,   0xFFFFFFFF
.equ    VID_BASE,   0x60000000
.equ    LED_IOCTL,  0x80000000
.equ    RAM_SIZE,   0x00001000
.equ    RAM_BASE,   0x00040000
.equ    TOPSTACK,   RAM_BASE + RAM_SIZE
@ system call for breaking out of the simulator
.equ    SYS_HALT,   0x01
ldr  r0,  =TOPSTACK
mov  r13, r0  @ R13 acts as stack pointer by convention

mov r4, #1
loop:
@ switch some LEDs on and off
bl _toggle_leds
add r4, r4, #1

@ print a string
ldr r0, =hello
bl _printf
b loop @ infinite loop

@ halts execution
_exit:
  ldr r0, =SYS_CALL
  ldr r1, =SYS_HALT
  strb r1, [r0]

@ IN(r4) -> bit flags of LEDs to turn on/off
_toggle_leds:
  stmfd sp!, {r1}
  ldr r1, =LED_IOCTL
  strb r4, [r1], #0
  ldmfd sp!, {r1}
  bx lr

@ IN(r0) -> address of null-terminated string
_printf:
  stmfd sp!, {r1-r3}
  ldr r2, =VID_BASE
  while:
    ldrb r1, [r0], #1
    cmp r1, #0
    beq end_while
    strb r1, [r2], #1
    b while
  end_while:
  ldmfd sp!, {r1-r3}
  bx lr 
.end
</script>
</html>