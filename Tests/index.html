<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ARM.JS Tests</title>
  <link rel="stylesheet" href="lib/jasmine-2.4.1/jasmine.css">

  <script src="lib/jquery-2.2.3.min.js"></script>
  <script src="lib/source-map.min.js"></script>
  <script src="lib/jasmine-2.4.1/jasmine.js"></script>
  <script src="lib/jasmine-2.4.1/jasmine-html.js"></script>
  <script src="lib/jasmine-2.4.1/boot.js"></script>

  <script src="../Simulator/Condition.js"></script>
  <script src="../Simulator/Cpsr.js"></script>
  <script src="../Simulator/CpuException.js"></script>
  <script src="../Simulator/CpuMode.js"></script>
  <script src="../Simulator/CpuState.js"></script>
  <script src="../Simulator/DataType.js"></script>
  <script src="../Simulator/Device.js"></script>
  <script src="../Simulator/Helper.js"></script>
  <script src="../Simulator/Region.js"></script>
  <script src="MockService.js"></script>

  <script src="../Simulator/Cpu.js" data-test></script>
  <script src="../Simulator/Memory.js" data-test></script>
  <script src="../Simulator/Devices/DS1307.js" data-test></script>
  <script src="../Simulator/Devices/HD44780U.js" data-test></script>
  <script src="../Simulator/Devices/PIC.js" data-test></script>
  <script src="../Simulator/Devices/Timer.js" data-test></script>
  <script src="../Simulator/Devices/TL16C750.js" data-test></script>
  <script src="../Simulator/Devices/Watchdog.js" data-test></script>
  <script src="../Simulator/Devices/GPIO.js" data-test></script>
  <script src="../Simulator/Vm.js" data-test></script>

  <script>
    var smaps  = {},
        tests  = $('script[data-test]'),
        scripts = {};
    tests.each(function() {
      var basename  = this.src.replace(/^.*\/(.*)\.js/, '$1'),
          testfile  = 'Test.' + basename + '.js',
          tsfile    = 'Test.' + basename + '.ts';
      $.getScript(testfile, function(data) {
        scripts[tsfile] = data;
        loaded(tsfile);
      });
      $.get(testfile + '.map', {}, function(data) {
        smaps[tsfile] = new sourceMap.SourceMapConsumer(data);
        loaded(tsfile);
      });
    });
    
    // Contains file and line information for each test
    var tsLines = {};
    
    function loaded(name) {
      if (scripts[name] && smaps[name])
        $.extend(tsLines, mapTestsToLines(scripts[name], smaps[name], name));
      // If everything has been loaded, run tests.
      if(Object.keys(smaps).length < tests.length)
        return;
      if(Object.keys(scripts).length < tests.length)
        return;
      window.jasmine.getEnv().execute();
    }
    
    function mapTestsToLines(js, smap, file) {
      var ret = {};
      // Construct array with new line position indices
      var r = new RegExp("\\n", "g"),
          newlines = [],
          m;
      while((m = r.exec(js)) != null)
        newlines.push(m.index);
      // Extract suite and test definitions from JS file
      m = js.match(/^\s*describe\s*\(\s*'(.*)'/);
      if(!m)
        throw new Error('Could not find suite description');
      var s = m[1];
      r = new RegExp("^((\\s*)it\\s*\\(\\s*')(.*)'", 'gm');
        while ((m = r.exec(js)) != null) {
          var _column    = m[2].length,
              testname   = m[3],
              line_in_js = lineForIndex(newlines, m.index + m[1].length),
              line_in_ts = smap.originalPositionFor({line: line_in_js,
                column: _column});
          ret[s + ' ' + testname] = {line: line_in_ts.line, 'file': file};
        }
        return ret;
    }
    
    function lineForIndex(array, index) {
      var min = 0,
          max = array.length - 1,
          pos, elem;
      while (min <= max) {
        pos = (min + max) / 2 | 0;
        elem = array[pos]; 
        if (elem < index)
          min = pos + 1;
        else if (elem > index)
          max = pos - 1;
        else
          return pos;
      }
      return min + 1;
    }
    </script>
</head>
<body>
</body>
</html>
